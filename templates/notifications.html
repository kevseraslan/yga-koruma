{% extends "base.html" %}

{% block title %}Bildirimler - ReviseMe{% endblock title %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="fas fa-bell me-2 text-primary"></i>Bildirimleriniz</h2>
        <div>
            <button class="btn btn-outline-primary me-2" id="refreshNotifications">
                <i class="fas fa-sync-alt me-1"></i> Yenile
            </button>
            <button class="btn btn-outline-danger" id="clearAllNotifications">
                <i class="fas fa-trash me-1"></i> Tümünü Temizle
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- Notification statistics card removed -->
        
        <!-- Soru Bildirimleri -->
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="fas fa-book-open me-2 text-primary"></i>Soru Bildirimleri</h4>
                <span class="badge bg-primary rounded-pill">{{ today_questions|length + past_questions|length }}</span>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0"><i class="fas fa-rocket me-2"></i>Bugünkü Sorular</h5>
                        </div>
                        <div class="card-body">
                            {% if today_questions|length > 0 %}
                                <p class="card-text">Bugün çözmen gereken <b>{{ today_questions|length }}</b> soru seni bekliyor!</p>
                                <div class="list-group mb-3">
                                    {% for question in today_questions[:3] %}
                                        <a href="{{ url_for('view_today_question', question_id=question.QuestionId) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-question-circle text-primary me-2"></i>
                                                {{ question.Content|truncate(50) }}
                                            </div>
                                            <span class="badge bg-primary rounded-pill">Tekrar {{ question.RepeatCount + 1 }}</span>
                                        </a>
                                    {% endfor %}
                                    {% if today_questions|length > 3 %}
                                        <div class="text-center mt-2">
                                            <small class="text-muted">ve {{ today_questions|length - 3 }} soru daha...</small>
                                        </div>
                                    {% endif %}
                                </div>
                                <a href="{{ url_for('today_questions') }}" class="btn btn-primary w-100">
                                    <i class="fas fa-arrow-right me-1"></i> Tüm Bugünkü Soruları Görüntüle
                                </a>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <p>Harika! Bugün için bekleyen soru bulunmuyor.</p>
                                    <a href="{{ url_for('add_question') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-plus me-1"></i> Yeni Soru Ekle
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-warning text-white">
                            <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Geçmiş Tekrarlar</h5>
                        </div>
                        <div class="card-body">
                            {% if past_questions|length > 0 %}
                                <p class="card-text"><b>{{ past_questions|length }}</b> sorunun tekrar günü geçmiş, unutmadan tekrar et!</p>
                                <div class="list-group mb-3">
                                    {% for question in past_questions[:3] %}
                                        <a href="{{ url_for('view_question', question_id=question.QuestionId) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-history text-warning me-2"></i>
                                                {{ question.Content|truncate(50) }}
                                            </div>
                                            <span class="badge bg-warning text-dark rounded-pill">{{ question.RepeatCount + 1 }}. tekrar</span>
                                        </a>
                                    {% endfor %}
                                    {% if past_questions|length > 3 %}
                                        <div class="text-center mt-2">
                                            <small class="text-muted">ve {{ past_questions|length - 3 }} soru daha...</small>
                                        </div>
                                    {% endif %}
                                </div>
                                <a href="{{ url_for('past_questions') }}" class="btn btn-warning w-100">
                                    <i class="fas fa-arrow-right me-1"></i> Tüm Geçmiş Tekrarları Görüntüle
                                </a>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-trophy fa-3x text-warning mb-3"></i>
                                    <p>Tebrikler! Tüm sorularını zamanında tekrar ediyorsun.</p>
                                    <a href="{{ url_for('progress') }}" class="btn btn-outline-warning">
                                        <i class="fas fa-chart-line me-1"></i> İlerlemeni Görüntüle
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Görev Bildirimleri -->
        <div class="col-12 mb-4">
            <!-- Task notifications heading removed -->
            <div class="row g-3">
                {% if overdue_tasks|default([])|length > 0 %}
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-danger text-white">
                            <h5 class="card-title mb-0"><i class="fas fa-exclamation-circle me-2"></i>Geciken Görevler</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text"><b>{{ overdue_tasks|length }}</b> görev son tarihini geçirdi. Hemen tamamla!</p>
                            <div class="list-group mb-3">
                                {% for task in overdue_tasks[:3] %}
                                <a href="{{ url_for('edit_task', task_id=task.TaskId) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-calendar-times text-danger me-2"></i>
                                        {{ task.Title }}
                                    </div>
                                    <div>
                                        <span class="badge bg-danger rounded-pill">{{ task.DueDate.strftime('%d.%m.%Y') }}</span>
                                        <span class="badge bg-secondary ms-1">{{ task.Category }}</span>
                                    </div>
                                </a>
                                {% endfor %}
                                {% if overdue_tasks|length > 3 %}
                                <div class="text-center mt-2">
                                    <small class="text-muted">ve {{ overdue_tasks|length - 3 }} görev daha...</small>
                                </div>
                                {% endif %}
                            </div>
                            <a href="{{ url_for('tasks', filter='overdue') }}" class="btn btn-danger w-100">
                                <i class="fas fa-arrow-right me-1"></i> Tüm Geciken Görevleri Görüntüle
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if new_tasks|default([])|length > 0 %}
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0"><i class="fas fa-plus-circle me-2"></i>Yeni Görevler</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Son 24 saat içinde <b>{{ new_tasks|length }}</b> yeni görev oluşturuldu.</p>
                            <div class="list-group mb-3">
                                {% for task in new_tasks[:3] %}
                                <a href="{{ url_for('edit_task', task_id=task.TaskId) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file-alt text-info me-2"></i>
                                        {{ task.Title }}
                                    </div>
                                    <div>
                                        <span class="badge bg-info rounded-pill">{{ task.CreatedAt.strftime('%H:%M') }}</span>
                                        <span class="badge bg-secondary ms-1">{{ task.Category }}</span>
                                    </div>
                                </a>
                                {% endfor %}
                                {% if new_tasks|length > 3 %}
                                <div class="text-center mt-2">
                                    <small class="text-muted">ve {{ new_tasks|length - 3 }} görev daha...</small>
                                </div>
                                {% endif %}
                            </div>
                            <a href="{{ url_for('tasks', filter='new') }}" class="btn btn-info w-100">
                                <i class="fas fa-arrow-right me-1"></i> Tüm Yeni Görevleri Görüntüle
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if completed_tasks|default([])|length > 0 %}
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0"><i class="fas fa-check-circle me-2"></i>Tamamlanan Görevler</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Bugün <b>{{ completed_tasks|length }}</b> görevi başarıyla tamamladın!</p>
                            <div class="list-group mb-3">
                                {% for task in completed_tasks[:3] %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-check text-success me-2"></i>
                                        <s>{{ task.Title }}</s>
                                    </div>
                                    <div>
                                        <span class="badge bg-success rounded-pill">{{ task.CompletedAt.strftime('%H:%M') }}</span>
                                        <span class="badge bg-secondary ms-1">{{ task.Category }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if completed_tasks|length > 3 %}
                                <div class="text-center mt-2">
                                    <small class="text-muted">ve {{ completed_tasks|length - 3 }} görev daha...</small>
                                </div>
                                {% endif %}
                            </div>
                            <a href="{{ url_for('tasks', filter='completed') }}" class="btn btn-success w-100">
                                <i class="fas fa-arrow-right me-1"></i> Tüm Tamamlanan Görevleri Görüntüle
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if (overdue_tasks|default([])|length == 0) and (new_tasks|default([])|length == 0) and (completed_tasks|default([])|length == 0) %}
                <!-- Task notifications section removed -->
                {% endif %}
            </div>
        </div>
        {% if today_questions|length == 0 and past_questions|length == 0 and completed_today|length == 0 and overdue_tasks|default([])|length == 0 and completed_tasks|default([])|length == 0 and new_tasks|default([])|length == 0 %}
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-bell-slash fa-4x text-muted mb-3"></i>
                    <h4>Bildirim Bulunmuyor</h4>
                    <p class="text-muted">Tüm görevleriniz ve sorularınız güncel durumda. Yeni bildirimler geldiğinde burada görüntülenecektir.</p>
                    <div class="mt-3">
                        <a href="{{ url_for('add_question') }}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-plus me-1"></i> Yeni Soru Ekle
                        </a>
                        <a href="{{ url_for('add_task') }}" class="btn btn-outline-danger">
                            <i class="fas fa-plus me-1"></i> Yeni Görev Ekle
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Notification settings card removed -->
</div>
{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Bildirim sayfasını yenile
        document.getElementById('refreshNotifications').addEventListener('click', function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Yenileniyor...';
            
            // Sayfayı yenile
            setTimeout(function() {
                window.location.reload();
            }, 500);
        });
        
        // Tüm bildirimleri temizle
        document.getElementById('clearAllNotifications').addEventListener('click', function() {
            if (confirm('Tüm bildirimleri temizlemek istediğinize emin misiniz?')) {
                const button = this;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Temizleniyor...';
                
                // Bildirim temizleme isteği gönder
                fetch('/clear-all-notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('success', 'Tüm bildirimler başarıyla temizlendi!');
                        setTimeout(function() {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showNotification('error', 'Bildirimler temizlenirken bir hata oluştu: ' + data.error);
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-trash me-1"></i> Tümünü Temizle';
                    }
                })
                .catch(error => {
                    showNotification('error', 'Bir hata oluştu: ' + error);
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-trash me-1"></i> Tümünü Temizle';
                });
            }
        });
        
        // Bildirim ayarlarını kaydet
        document.getElementById('saveNotificationSettings').addEventListener('click', function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Kaydediliyor...';
            
            // Ayarları topla
            const settings = {
                questionNotifications: document.getElementById('questionNotifications').checked,
                taskNotifications: document.getElementById('taskNotifications').checked,
                systemNotifications: document.getElementById('systemNotifications').checked,
                emailNotifications: document.getElementById('emailNotifications').checked,
                browserNotifications: document.getElementById('browserNotifications').checked,
                smsNotifications: document.getElementById('smsNotifications').checked
            };
            
            // Ayarları kaydetme isteği gönder
            fetch('/save-notification-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('success', 'Bildirim ayarları başarıyla kaydedildi!');
                } else {
                    showNotification('error', 'Ayarlar kaydedilirken bir hata oluştu: ' + data.error);
                }
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-save me-1"></i> Ayarları Kaydet';
            })
            .catch(error => {
                showNotification('error', 'Bir hata oluştu: ' + error);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-save me-1"></i> Ayarları Kaydet';
            });
        });
        
        // Tarayıcı bildirimleri için izin iste
        document.getElementById('browserNotifications').addEventListener('change', function() {
            if (this.checked && Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission !== 'granted') {
                        this.checked = false;
                        showNotification('warning', 'Tarayıcı bildirimleri için izin verilmedi.');
                    }
                });
            }
        });
        
        // Bildirim göster
        function showNotification(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // CSS ekle
        const style = document.createElement('style');
        style.textContent = `
            .notification-icon {
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock scripts %}
